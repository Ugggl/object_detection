<html>
  <head>
    <title>Video Streaming Detection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.9/cropper.min.css" />
    <style>
    	#image {
    		width: 1280px;
    		height: 720px;
    	}
    	#zone_btn {
    		display: block;
    		width: 200px;
    		height: 40px;
    		margin-top: 20px;
    	}
    </style>
  </head>
  <body>
  	<div id="image">
    	<img src="{{ stream_url }}" width="1280" height="720" id="show" class="{{ target }}">
    </div>
    <button id="zone_btn" class="unclicked">Отметить зону</button>


    <!-- connect scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.9/cropper.min.js"></script>
    <script>
        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    	var cropper = false;
        var stream_id = {{ id }};

		$('#zone_btn').on('click', function(event) {
			if ($(this).hasClass('unclicked'))
			{
				$(this).removeClass('unclicked').addClass('clicked')
				$(this).text('Подтвердить')

                if ($('#show').hasClass('stream'))
                    $('#show').attr('src', '/photo/' + stream_id.toString());

				cropper = new Cropper(document.getElementById('show'), {
				  background: false,
				});
			}
			else
			{
				$(this).removeClass('clicked').addClass('unclicked')
				$(this).text('Отметить зону')
                var coords = cropper.getData(true)
				cropper.destroy()

                if ($('#show').hasClass('stream'))
                    $('#show').attr('src', '/stream/' + stream_id.toString());

                $.getJSON($SCRIPT_ROOT + '/change_zone', {
                    stream_id: stream_id,
                    x: coords.x,
                    y: coords.y,
                    width: coords.width,
                    height: coords.height
                }, function() {
                    console.log("success");
                });
                
                if ($('#show').hasClass('preview'))
                    setTimeout(function() {
                        location.reload();
                    }, 500);
			}
		});
    </script>
  </body>
</html>
